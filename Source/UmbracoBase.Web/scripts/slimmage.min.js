/* Slimmage 0.2.x, use with ImageResizer. MIT/Apache2 dual licensed by Imazen */

(function(a){var d=window.slimmage||{};window.slimmage=d;if(d.verbose===undefined){d.verbose=true}if(d.tryWebP===undefined){d.tryWebP=false}if(d.readyCallback===undefined){d.readyCallback=null}if(d.maxWidth===undefined){d.maxWidth=2048}if(d.widthStep===undefined){d.widthStep=160}if(d.jpegQuality===undefined){d.jpegQuality=90}if(d.jpegRetinaQuality===undefined){d.jpegRetinaQuality=80}var c=function(){if(a.slimmage.verbose&&a.console&&a.console.log){try{a.console.log.apply(a.console,arguments)}catch(f){}}};d.beginWebPTest=function(){if(!d.tryWebP||d._testingWebP){return}d._testingWebP=true;var e=new Image();e.onload=e.onerror=function(){d.webp=(e.height==2)};e.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA"};d.getCssValue=function(f,e){var g=typeof(window.getComputedStyle)!="undefined"&&window.getComputedStyle(f,null).getPropertyValue(e);if(!g&&f.currentStyle){g=f.currentStyle[e.replace(/([a-z])\-([a-z])/,function(i,h,j){return h+j.toUpperCase()})]||f.currentStyle[e]}return g};d.getCssPixels=function(g,f){var h=d.getCssValue(g,f);if(h.slice(-2)=="px"){return parseFloat(h.slice(0,-2))}var e=document.createElement("div");e.style.overflow=e.style.visibility="hidden";e.style.cssFloat="none";g.parentNode.appendChild(e);e.style.width=h;var i=e.offsetWidth;g.parentNode.removeChild(e);return i};d.nodesToArray=function(e){var g=[];for(var f=e.length>>>0;f--;){g[f]=e[f]}return g};d.adjustImageSrcWithWidth=function(g,e,i){var j={webp:d.webp,width:i,dpr:window.devicePixelRatio||1,src:e};j.requestedWidth=Math.min(d.maxWidth,j.width*j.dpr),j.quality=(j.dpr>1.49)?d.jpegRetinaQuality:d.jpegQuality;if(j.webp){j.quality=j.dpr>1.49?65:78}j.requestedWidth=j.requestedWidth-(j.requestedWidth%d.widthStep)+d.widthStep;var f=g.getAttribute("data-pixel-width")|0;if(d.adjustImageParameters&&typeof(d.adjustImageParameters)==="function"){d.adjustImageParameters(j)}if(j.requestedWidth>f){var h=e.replace(/width=\d+/i,"width="+j.requestedWidth).replace(/quality=[0-9]+/i,"quality="+j.quality);if(j.webp){h=h.replace(/format=[a-z]+/i,"format=webp")}g.src=h;g.setAttribute("data-pixel-width",j.requestedWidth);c("Slimming: updating "+h)}};d.adjustImageSrc=function(f,e){d.adjustImageSrcWithWidth(f,e,d.getCssPixels(f,"max-width"))};d.checkResponsiveImages=function(x){if(d.timeoutid>0){a.clearTimeout(d.timeoutid)}d.timeoutid=0;if(x&&x>0){d.timeoutid=a.setTimeout(d.checkResponsiveImages,x);return}var g=new Date().getTime();var o=0;var p=d.nodesToArray(a.document.getElementsByTagName("noscript"));for(var r=0,h=p.length;r<h;r++){var y=p[r];if(y.getAttribute("data-slimmage")!==null){var m=a.document.createElement("div");var v=(y.textContent||y.innerHTML);if(!v||v.replace(/[\s\t\r\n]+/,"").length==0){var z=new Image();for(var s=0;s<y.attributes.length;s++){var w=y.attributes[s];if(w&&w.specified&&w.name.indexOf("data-img-")==0){z.setAttribute(w.name.slice(9-w.name.length),w.value)}}m.appendChild(z)}else{m.innerHTML=v.replace(/\s+src\s*=\s*(['"])/i," data-src=$1").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}var e=m.getElementsByTagName("img");for(var q=0,t=e.length;q<t;q++){var l=e[q];if(l.src!==null&&l.src.length>0){l.setAttribute("data-src",l.src);l.src=""}l.setAttribute("data-slimmage",true);y.parentNode.insertBefore(l,y);o++}y.parentNode.removeChild(y)}}var u=0;var k=d.nodesToArray(a.document.getElementsByTagName("img"));for(var r=0,h=k.length;r<h;r++){if(k[r].getAttribute("data-slimmage")!==null){var f=k[r].getAttribute("data-src")||k[r].src;d.adjustImageSrc(k[r],f);u++}}if(typeof d.readyCallback==="function"){d.readyCallback()}c("Slimmage: restored "+o+" images from noscript tags; sizing "+u+" images. "+(new Date().getTime()-g)+"ms")};var b=d.checkResponsiveImages;if(a.addEventListener){a.addEventListener("resize",function(){b(500)},false);a.addEventListener("DOMContentLoaded",function(){b();a.removeEventListener("load",b,false)},false);a.addEventListener("load",b,false)}else{if(a.attachEvent){a.attachEvent("onload",b)}}d.beginWebPTest()}(this));